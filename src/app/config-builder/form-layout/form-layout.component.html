<mat-card
  class="cardWithShadow theme-card"
  [class.void-card]="isChildForm() && !config.ui.formLabel"
>
  @if (config.ui.formLabel) {
    <mat-card-header>
      <div class="header-flex">
        <mat-card-title class="m-b-0">{{ config.ui.formLabel }}</mat-card-title>
        <div class="header-actions">
          @if (showDeleteButton() && !this.mainForm.disabled) {
            <div
              class="raised-btn text-danger"
              (click)="this.addOrDelete.emit(false)"
            >
              <mat-icon>delete_forever</mat-icon>
            </div>
          }
          @if (showAddButton() && !this.mainForm.disabled) {
            <div
              class="raised-btn text-primary"
              (click)="this.addOrDelete.emit(true)"
            >
              <mat-icon>add</mat-icon>
            </div>
          }
        </div>
      </div>
    </mat-card-header>
  }
  <mat-card-content
    class="b-t-1"
    [class.void-card-content]="isChildForm() && !config.ui.formLabel"
  >
    <!-- Direct access to visibleLayers with @for -->
    @for (layer of this.config.ui.elementsLayout; track layer) {
      <div [ngClass]="isLayerVisible(layer) ? 'row gx-2' : 'd-none'">
        @for (element of layer; track element) {
          @if (
            this.visibleLayers().flat().includes(element) &&
            element._refAttributes
          ) {
            <!-- If form is group -->
            @let attr = config.ui.references.attributes[element._refAttributes];
            @if (attr) {
              @if (isFormGroup()) {
                @if (
                  attr.type === fieldTypes.FORM_GROUP ||
                  attr.type === fieldTypes.FORM_ARRAY
                ) {
                  <div class="col-12">
                    <app-form-layout
                      [config]="{
                        disclosure_name: attr.label,
                        disclosure_type: attr.id,
                        ui: attr.nestedElement,
                      }"
                      [mainForm]="$any(mainForm.get(element._refAttributes))"
                      [isChildForm]="true"
                      [status]="status"
                    />
                  </div>
                } @else {
                  <div class="col">
                    <app-field-selector
                      (onChange)="updateAccessControl()"
                      [formField]="$any(mainForm.get(element._refAttributes))"
                      [element]="attr"
                      [isFormSubmitted]="isFormSubmitted()"
                    />
                  </div>
                }
              } @else if (isFormArray()) {
                @let dummyUI = fallbackUI;
                @let isNested =
                  attr.type === fieldTypes.FORM_GROUP ||
                  attr.type === fieldTypes.FORM_ARRAY;
                @let ui = isNested ? attr.nestedElement : dummyUI;
                @let config =
                  {
                    disclosure_name: attr.label,
                    disclosure_type: attr.id,
                    ui,
                  };
                <div class="col-12">
                  <div class="row">
                    @for (
                      control of formArrayControls();
                      track control;
                      let i = $index
                    ) {
                      @if (isNested) {
                        <div class="layout-row">
                          <app-form-layout
                            [config]="config"
                            [mainForm]="$any(control)"
                            [isChildForm]="true"
                            [status]="status"
                            [showAddButton]="true"
                            [showDeleteButton]="i !== 0"
                            (addOrDelete)="addOrRemoveElement($event, i, config)"
                            class="flex-grow-1"
                          />
                          <span
                            class="delete-btn"
                            (click)="addOrRemoveElement(false, i)"
                          >
                            @if (!attr.nestedElement.formLabel && i !== 0) {
                              <mat-icon>delete_forever</mat-icon>
                            }
                          </span>
                        </div>
                      } @else {
                        @let elementsToFit = attr.maxAllowedElementsInRow ?? 1;
                        @let fieldClass =
                          elementsToFit
                            ? "col-" + 12 / elementsToFit
                            : "col-12";
                        <div [class]="fieldClass">
                          <app-field-selector
                            (onChange)="updateAccessControl()"
                            [formField]="$any(control)"
                            [element]="attr"
                            [isFormSubmitted]="isFormSubmitted()"
                            [showAddButton]="true"
                            [showDeleteButton]="i !== 0"
                            (addOrRemoveControl)="addOrRemoveElement($event, i)"
                          />
                        </div>
                      }
                    }
                  </div>
                </div>
                @if (isNested && !!config.ui && !config.ui.formLabel) {
                  <div class="d-flex justify-content-center mb-3">
                    <button
                      (click)="
                        addOrRemoveElement(true, formArrayControls().length, config)
                      "
                      mat-raised-button
                      color="primary"
                    >
                      Add More Fields
                    </button>
                  </div>
                }
              }
            }
          } @else if (
            this.visibleLayers().flat().includes(element) &&
            element._paragraphAttributes
          ) {
            <div class="col">
              <app-text-element
                [element]="
                  config.ui.paragraphs.textAttributes[
                    element._paragraphAttributes
                  ]
                "
                [form]="mainForm"
              ></app-text-element>
            </div>
          }
        }
      </div>
    }
  </mat-card-content>
  @if (this.config.ui.actions) {
    <mat-card-content class="b-t-1">
      <div class="col">
        <app-action-buttons
          [buttonsConfig]="{
            justification: this.config.ui.actions.justification,
            buttons: this.visibleActionButton,
          }"
          (onClick)="submit($event)"
        ></app-action-buttons>
      </div>
    </mat-card-content>
  }
</mat-card>
